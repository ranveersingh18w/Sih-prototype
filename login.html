<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login / Signup - AyurTrace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .tab-btn.active {
            border-color: var(--primary-green);
            color: var(--primary-green);
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-light-gray">

    <div class="container mx-auto min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-5xl bg-white rounded-2xl shadow-2xl grid md:grid-cols-2 overflow-hidden">
            <!-- Left Panel -->
            <div class="p-8 md:p-12">
                <div class="mb-8">
                    <a href="index.html" class="flex items-center space-x-3">
                        <img src="https://placehold.co/40x40/006A4E/FFFFFF?text=A" alt="AyurTrace Logo" class="rounded-full">
                        <h1 class="text-2xl font-bold text-gray-800">AyurTrace</h1>
                    </a>
                </div>

                <h2 class="text-2xl font-bold text-dark-gray mb-2">Secure access to your supply chain dashboard</h2>
                <p id="form-title" class="text-medium-gray mb-8">Welcome Back</p>

                <div class="flex border-b-2 border-gray-200 mb-8">
                    <button id="loginTabBtn" class="tab-btn flex-1 py-2 font-semibold text-gray-500 border-b-2 border-transparent hover:text-gray-700 focus:outline-none active">Login</button>
                    <button id="registerTabBtn" class="tab-btn flex-1 py-2 font-semibold text-gray-500 border-b-2 border-transparent hover:text-gray-700 focus:outline-none">Sign Up</button>
                </div>

                <!-- Login Form -->
                <div id="loginForm">
                    <div class="space-y-4">
                        <div>
                            <label for="loginActorId" class="block text-sm font-medium text-gray-700">Actor ID / Email</label>
                            <input id="loginActorId" type="text" placeholder="e.g., FARM001" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-green focus:border-primary-green">
                        </div>
                        <div>
                            <label for="loginPassword" class="block text-sm font-medium text-gray-700">Password</label>
                            <input id="loginPassword" type="password" placeholder="********" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-green focus:border-primary-green">
                        </div>
                        <div>
                            <label for="loginActorRole" class="block text-sm font-medium text-gray-700">Select Your Role</label>
                            <select id="loginActorRole" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-primary-green focus:border-primary-green">
                                <option value="1">üåæ Farmer</option>
                                <option value="2">üë∑ Collector</option>
                                <option value="3">üïµÔ∏è Auditor</option>
                                <option value="4">üè≠ Manufacturer</option>
                                <option value="5">üöö Distributor</option>
                            </select>
                        </div>
                    </div>
                    <button id="btnLogin" class="mt-6 w-full btn btn-primary">Sign In</button>
                </div>
                
                <!-- Registration Form -->
                <div id="registerForm" class="hidden">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="regFullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input id="regFullName" type="text" placeholder="Your full name" class="mt-1 block w-full input-field">
                        </div>
                        <div>
                            <label for="regActorId" class="block text-sm font-medium text-gray-700">Actor ID / Email</label>
                            <input id="regActorId" type="text" placeholder="e.g., FARM001" class="mt-1 block w-full input-field">
                        </div>
                        <div class="md:col-span-2">
                            <label for="regActorRole" class="block text-sm font-medium text-gray-700">Role</label>
                            <select id="regActorRole" class="mt-1 block w-full input-field">
                                <option value="1">üåæ Farmer</option>
                                <option value="2">üë∑ Collector</option>
                                <option value="3">üïµÔ∏è Auditor</option>
                                <option value="4">üè≠ Manufacturer</option>
                                <option value="5">üöö Distributor</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="regAddress" class="block text-sm font-medium text-gray-700">Location / Address</label>
                            <input id="regAddress" type="text" placeholder="City, State" class="mt-1 block w-full input-field">
                        </div>
                         <div>
                            <label for="regPhone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                            <input id="regPhone" type="tel" placeholder="Your phone number" class="mt-1 block w-full input-field">
                        </div>
                        <div>
                            <label for="regPassword" class="block text-sm font-medium text-gray-700">Password</label>
                            <input id="regPassword" type="password" placeholder="Create a password" class="mt-1 block w-full input-field">
                        </div>
                    </div>
                     <button id="btnRegisterAndLogin" class="mt-6 w-full btn btn-primary">Create Account</button>
                </div>

                <div id="authFeedback" class="hidden p-4 rounded-md text-sm mt-4"></div>

                <div class="text-center mt-6">
                    <a href="index.html" class="text-sm font-medium text-primary-green hover:underline">‚Üê Back to Home</a>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="hidden md:block">
                <img src="https://placehold.co/800x1000/2E8B57/FFFFFF?text=Secure.+Transparent.+Trusted." alt="Ayurvedic products in bottles" class="w-full h-full object-cover">
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="supabase-auth.js"></script>
    <script>
        const UI = {
            init() {
                document.getElementById('btnRegisterAndLogin').addEventListener('click', () => this.registerAndLogin());
                document.getElementById('btnLogin').addEventListener('click', () => this.login());

                const loginTab = document.getElementById('loginTabBtn');
                const registerTab = document.getElementById('registerTabBtn');
                const loginForm = document.getElementById('loginForm');
                const registerForm = document.getElementById('registerForm');
                const formTitle = document.getElementById('form-title');

                loginTab.addEventListener('click', () => {
                    loginTab.classList.add('active');
                    registerTab.classList.remove('active');
                    loginForm.classList.remove('hidden');
                    registerForm.classList.add('hidden');
                    formTitle.textContent = 'Welcome Back';
                });

                registerTab.addEventListener('click', () => {
                    registerTab.classList.add('active');
                    loginTab.classList.remove('active');
                    registerForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                    formTitle.textContent = 'Join AyurTrace';
                });
            },

            showFeedback(elId, message, type) {
                const el = document.getElementById(elId);
                el.className = 'p-4 rounded-md text-sm mt-4';
                if (type === 'success') el.classList.add('bg-green-100', 'text-green-800');
                else if (type === 'error') el.classList.add('bg-red-100', 'text-red-800');
                else el.classList.add('bg-blue-100', 'text-blue-800');
                el.innerHTML = message;
                el.style.display = 'block';
            },
            
            handleSuccessfulAuth(userData) {
                const userKey = `ayurtrace_user_${userData.actorId}_${userData.role}`;
                localStorage.setItem(userKey, JSON.stringify(userData));
                sessionStorage.setItem('ayurtrace_currentUserKey', userKey);
                window.location.href = 'dashboard.html';
            },

            async registerAndLogin() {
                const actorId = document.getElementById('regActorId').value.trim();
                const password = document.getElementById('regPassword').value;
                const fullName = document.getElementById('regFullName').value.trim();
                const phone = document.getElementById('regPhone').value.trim();
                const address = document.getElementById('regAddress').value.trim();
                const role = parseInt(document.getElementById('regActorRole').value);

                if (!actorId || !password || !fullName || !address || !phone) {
                    return this.showFeedback('authFeedback', "Please fill in all details.", 'error');
                }

                this.showFeedback('authFeedback', 'Creating account...', 'info');
                const newUserInDb = await signUp(actorId, password, fullName, phone, address, role);

                if (!newUserInDb) {
                    return this.showFeedback('authFeedback', 'This Actor ID may already be registered for the selected role.', 'error');
                }

                this.showFeedback('authFeedback', `Account for ${actorId} created! Logging in...`, 'success');
                this.handleSuccessfulAuth(newUserInDb);
            },

            async login() {
                const actorId = document.getElementById('loginActorId').value.trim();
                const password = document.getElementById('loginPassword').value;
                const role = parseInt(document.getElementById('loginActorRole').value);

                if (!actorId || !password) {
                    return this.showFeedback('authFeedback', "Please enter Actor ID and Password.", 'error');
                }

                this.showFeedback('authFeedback', 'Logging in...', 'info');
                const storedUser = await signIn(actorId, password, role);

                if (!storedUser) {
                    return this.showFeedback('authFeedback', 'Incorrect Actor ID, Password, or Role.', 'error');
                }

                this.showFeedback('authFeedback', 'Login successful! Redirecting...', 'success');
                setTimeout(() => this.handleSuccessfulAuth(storedUser), 1000);
            },
        };

        // Attach event listeners after the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => UI.init());
    </script>
</body>
</html>
