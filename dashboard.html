<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AyurTrace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
    <!-- QR Code Libraries -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .input { @apply block w-full px-4 py-2 mt-2 text-gray-700 bg-white border border-gray-200 rounded-md focus:border-indigo-400 focus:ring-indigo-300 focus:ring-opacity-40 focus:outline-none focus:ring; }
        .btn-primary { @apply w-full px-6 py-2.5 text-sm font-medium tracking-wide text-white capitalize transition-colors duration-300 transform bg-indigo-600 rounded-lg hover:bg-indigo-500 focus:outline-none focus:ring focus:ring-indigo-300 focus:ring-opacity-50; }
        .card { @apply bg-white p-6 rounded-2xl shadow-lg; }
    </style>
</head>

<body>
    <!-- Full-screen loader -->
    <div id="appLoader" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-indigo-600 mx-auto"></div>
            <h2 class="text-2xl font-semibold text-gray-700 mt-4">Loading Dashboard...</h2>
            <p class="text-gray-500">Connecting to your account.</p>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="appContainer" class="hidden">
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">AyurTrace Dashboard</h1>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p id="userName" class="font-semibold text-gray-700"></p>
                        <p id="userRole" class="text-sm text-gray-500"></p>
                    </div>
                    <button id="btnLogout" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">Logout</button>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 md:p-6 space-y-6">
            <!-- Search Section -->
            <section class="card">
                <h2 class="text-xl font-bold text-gray-800">Track a Batch</h2>
                <div class="mt-4 flex flex-col sm:flex-row gap-4">
                    <input id="searchInput" type="text" placeholder="Enter Batch ID to track" class="input flex-grow">
                    <button id="btnSearch" class="btn-primary sm:w-auto">Search</button>
                </div>
                <div id="searchResult" class="mt-4"></div>
            </section>

            <!-- QR Code Scanner Section -->
            <section id="scannerContainer" class="hidden card">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Scan Batch ID QR Code</h2>
                <div id="qr-reader" class="w-full max-w-sm mx-auto border-2 border-dashed border-gray-300 rounded-lg overflow-hidden"></div>
                <button id="closeScannerBtn" class="mt-4 mx-auto block bg-red-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-600">Close Scanner</button>
            </section>

            <!-- Role-specific Dashboards -->
            <div id="farmerDashboard" class="hidden card">
                <h2 class="text-xl font-bold text-gray-800">Farmer: Create New Batch</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <input id="f_batchId" type="text" placeholder="New Batch ID (e.g., FR-001-TIMESTAMP)" class="input">
                    <input id="f_cropName" type="text" placeholder="Crop Name" class="input">
                    <input id="f_quantity" type="number" placeholder="Quantity (units)" class="input">
                </div>
                <button id="btn_f_createBatch" class="mt-4 btn-primary">Create Batch</button>
                <div id="farmerFeedback" class="hidden mt-4 p-4 rounded-md text-sm"></div>
            </div>

            <div id="collectorDashboard" class="hidden card">
                <h2 class="text-xl font-bold text-gray-800">Collector: Receive Batch</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <input id="c_batchId" type="text" placeholder="Previous Batch ID" class="input col-span-2">
                    <button id="c_scanBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 col-span-2">Scan QR</button>
                    <input id="c_cropName" type="text" placeholder="Crop Name" class="input">
                    <input id="c_quantity" type="number" placeholder="Quantity Received" class="input">
                </div>
                <button id="btn_c_forward" class="mt-4 btn-primary">Receive and Forward</button>
                <div id="collectorFeedback" class="hidden mt-4 p-4 rounded-md text-sm"></div>
            </div>

            <div id="auditorDashboard" class="hidden card">
                 <h2 class="text-xl font-bold text-gray-800">Auditor: Approve Batch</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <input id="a_batchId" type="text" placeholder="Batch ID from Collector" class="input col-span-2">
                    <button id="a_scanBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 col-span-2">Scan QR</button>
                    <input id="a_cropName" type="text" placeholder="Crop Name" class="input">
                    <input id="a_quantity" type="number" placeholder="Quantity Approved" class="input">
                </div>
                <button id="btn_a_approve" class="mt-4 btn-primary">Approve Batch</button>
                <div id="auditorFeedback" class="hidden mt-4 p-4 rounded-md text-sm"></div>
            </div>
            
            <div id="manufacturerDashboard" class="hidden card">
                <h2 class="text-xl font-bold text-gray-800">Manufacturer: Process Batch</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <input id="m_batchId" type="text" placeholder="Batch ID from Auditor" class="input col-span-2">
                     <button id="m_scanBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 col-span-2">Scan QR</button>
                    <input id="m_cropName" type="text" placeholder="Product Name" class="input">
                    <input id="m_quantity" type="number" placeholder="Final Product Quantity" class="input">
                    <input id="m_productId" type="text" placeholder="Final Product ID (e.g., AYUR-PROD-123)" class="input col-span-2">
                </div>
                <button id="btn_m_process" class="mt-4 btn-primary">Submit & Generate Product Batch</button>
                <div id="manufacturerFeedback" class="hidden mt-4 p-4 rounded-md text-sm"></div>

                <!-- Final QR Code Result -->
                <div id="manufacturerResult" class="hidden mt-6 p-6 border-2 border-dashed border-green-400 bg-green-50 rounded-lg text-center">
                    <h3 class="text-lg font-bold text-green-800">Product Batch Created!</h3>
                    <p class="text-gray-600">Use this QR code for the final product packaging.</p>
                    <canvas id="finalQrCanvas" class="mx-auto my-4 border"></canvas>
                    <p class="font-semibold text-gray-800">Shareable Tracking Link:</p>
                    <a id="finalQrLink" href="#" target="_blank" class="text-indigo-600 break-all hover:underline"></a>
                </div>
            </div>

            <div id="distributorDashboard" class="hidden card">
                <h2 class="text-xl font-bold text-gray-800">Distributor: Receive for Distribution</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <input id="d_batchId" type="text" placeholder="Batch ID from Manufacturer" class="input col-span-2">
                     <button id="d_scanBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 col-span-2">Scan QR</button>
                    <input id="d_cropName" type="text" placeholder="Product Name" class="input">
                    <input id="d_quantity" type="number" placeholder="Quantity Received" class="input">
                </div>
                <button id="btn_d_receive" class="mt-4 btn-primary">Receive Product</button>
                <div id="distributorFeedback" class="hidden mt-4 p-4 rounded-md text-sm"></div>
            </div>

            <!-- Previous Activity Section -->
            <section class="card">
                <h2 class="text-xl font-bold text-gray-800">Your Previous Batches</h2>
                <div id="previousActivity" class="mt-4 text-gray-600">
                    <p>No recent activity.</p>
                </div>
            </section>
        </main>
    </div>

    <script src="config.js"></script>
    <script>
        const ROLES = { 0: "Unknown", 1: "Farmer", 2: "Collector", 3: "Auditor", 4: "Manufacturer", 5: "Distributor" };

        const Blockchain = {
            provider: null,
            signer: null,
            contract: null,

            async init() {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error("MetaMask is not installed.");
                }
                this.provider = new ethers.BrowserProvider(window.ethereum);
                this.signer = await this.provider.getSigner();
                this.contract = new ethers.Contract(AppConfig.CONTRACT_ADDRESS, AppConfig.CONTRACT_ABI, this.signer);
            },

            async handleTransaction(txPromise, feedbackId) {
                const feedbackEl = document.getElementById(feedbackId);
                feedbackEl.className = "mt-4 p-4 rounded-md text-sm bg-yellow-100 text-yellow-800";
                feedbackEl.textContent = "Processing transaction... please wait.";
                feedbackEl.classList.remove('hidden');

                try {
                    const tx = await txPromise;
                    feedbackEl.textContent = "Transaction sent! Waiting for confirmation...";
                    const receipt = await tx.wait();
                    feedbackEl.className = "mt-4 p-4 rounded-md text-sm bg-green-100 text-green-800";
                    feedbackEl.textContent = `Success! Transaction confirmed in block ${receipt.blockNumber}.`;
                    return receipt;
                } catch (error) {
                    console.error("Transaction failed:", error);
                    feedbackEl.className = "mt-4 p-4 rounded-md text-sm bg-red-100 text-red-800";
                    feedbackEl.textContent = `Error: ${error.reason || error.message || "Transaction rejected."}`;
                    return null;
                }
            }
        };

        const App = {
            currentUser: null,
            html5QrCode: null,

            async init(userData) {
                this.currentUser = userData;
                try {
                    await Blockchain.init();
                    this.renderDashboard();
                    this.setupEventListeners();
                    this.displayPreviousActivity();
                } catch (error) {
                    alert(error.message);
                    window.location.href = 'login.html';
                } finally {
                    document.getElementById('appLoader').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                }
            },

            renderDashboard() {
                document.getElementById('userName').textContent = this.currentUser.name;
                document.getElementById('userRole').textContent = `Role: ${ROLES[this.currentUser.role]}`;
                const dashboardId = {
                    1: 'farmerDashboard', 2: 'collectorDashboard', 3: 'auditorDashboard',
                    4: 'manufacturerDashboard', 5: 'distributorDashboard'
                }[this.currentUser.role];
                if (dashboardId) {
                    document.getElementById(dashboardId).classList.remove('hidden');
                }
            },

            setupEventListeners() {
                document.getElementById('btnLogout').addEventListener('click', () => this.logout());
                document.getElementById('btnSearch').addEventListener('click', () => this.search());
                
                // QR Scanner Event Listeners
                document.getElementById('closeScannerBtn').addEventListener('click', () => this.stopScanner());
                const scanConfig = {
                    2: { btn: 'c_scanBtn', input: 'c_batchId' }, 3: { btn: 'a_scanBtn', input: 'a_batchId' },
                    4: { btn: 'm_scanBtn', input: 'm_batchId' }, 5: { btn: 'd_scanBtn', input: 'd_batchId' }
                };
                if (scanConfig[this.currentUser.role]) {
                    const { btn, input } = scanConfig[this.currentUser.role];
                    document.getElementById(btn).addEventListener('click', () => this.startScanner(input));
                }

                // Role-specific action buttons
                if (this.currentUser.role === 1) document.getElementById('btn_f_createBatch').addEventListener('click', () => this.farmer_createBatch());
                if (this.currentUser.role >= 2 && this.currentUser.role <= 5) {
                    const buttonId = { 2: 'btn_c_forward', 3: 'btn_a_approve', 4: 'btn_m_process', 5: 'btn_d_receive' }[this.currentUser.role];
                    document.getElementById(buttonId).addEventListener('click', () => this.stakeholder_submitBlock());
                }
            },

            startScanner(targetInputId) {
                document.getElementById('scannerContainer').classList.remove('hidden');
                this.html5QrCode = new Html5Qrcode("qr-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                
                const onScanSuccess = (decodedText, decodedResult) => {
                    document.getElementById(targetInputId).value = decodedText;
                    this.stopScanner();
                };

                this.html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                    .catch(err => {
                        console.error("Unable to start scanning.", err);
                        this.stopScanner();
                        alert("Could not start QR scanner. Please ensure camera permissions are granted.");
                    });
            },

            stopScanner() {
                if (this.html5QrCode && this.html5QrCode.isScanning) {
                    this.html5QrCode.stop().then(() => {
                        document.getElementById('scannerContainer').classList.add('hidden');
                    }).catch(err => console.error("Failed to stop scanner", err));
                } else {
                    document.getElementById('scannerContainer').classList.add('hidden');
                }
            },
            
            async search() {
                const batchId = document.getElementById('searchInput').value;
                const resultDiv = document.getElementById('searchResult');
                if (!batchId) {
                    resultDiv.innerHTML = '<p class="text-red-500">Please enter a Batch ID.</p>';
                    return;
                }
                resultDiv.innerHTML = '<p class="text-gray-500">Searching...</p>';
                try {
                    const chain = await Blockchain.contract.getFullChainByBatch(batchId);
                    if (chain.length === 0) {
                        resultDiv.innerHTML = `<p class="text-orange-500">No records found for Batch ID: ${batchId}</p>`;
                        return;
                    }
                    let html = chain.map(block => {
                        const ts = new Date(Number(block.createdAt) * 1000).toLocaleString();
                        return `<div class="p-2 border-b">
                                    <p><strong>${ROLES[block.role]}</strong> by ${block.name} on ${ts}</p>
                                    <p>Crop: ${block.cropName}, Qty: ${block.quantity.toString()}</p>
                                </div>`;
                    }).join('');
                    resultDiv.innerHTML = html;
                } catch (e) {
                    resultDiv.innerHTML = `<p class="text-red-500">Error fetching data for Batch ID ${batchId}.</p>`;
                }
            },

            async farmer_createBatch() {
                const batchId = document.getElementById('f_batchId').value;
                const cropName = document.getElementById('f_cropName').value;
                const quantity = document.getElementById('f_quantity').value;
                if (!batchId || !cropName || !quantity) {
                    alert("Please fill all fields."); return;
                }
                const txPromise = Blockchain.contract.createFarmerBlock(batchId, this.currentUser.name, cropName, quantity);
                const receipt = await Blockchain.handleTransaction(txPromise, 'farmerFeedback');
                if(receipt) {
                    this.addBatchToLocalStorage(batchId);
                    this.displayPreviousActivity();
                }
            },

            async stakeholder_submitBlock() {
                const role = this.currentUser.role;
                const prefix = { 2: 'c', 3: 'a', 4: 'm', 5: 'd' }[role];
                const batchId = document.getElementById(`${prefix}_batchId`).value.trim();
                const cropName = document.getElementById(`${prefix}_cropName`).value.trim();
                const quantity = document.getElementById(`${prefix}_quantity`).value.trim();
                const feedbackId = { 2: 'collectorFeedback', 3: 'auditorFeedback', 4: 'manufacturerFeedback', 5: 'distributorFeedback'}[role];
                
                if (!batchId || !cropName || !quantity) {
                    alert("Please fill all fields for your role."); return;
                }

                let txPromise;
                const commonArgs = [batchId, this.currentUser.name, cropName, quantity];
                switch (role) {
                    case 2: txPromise = Blockchain.contract.createCollectorBlock(...commonArgs); break;
                    case 3: txPromise = Blockchain.contract.createAuditorBlock(...commonArgs); break;
                    case 4:
                        const productId = document.getElementById('m_productId').value.trim();
                        txPromise = Blockchain.contract.createManufacturerBlock(...commonArgs, productId || '');
                        document.getElementById('manufacturerResult').classList.add('hidden'); // Hide previous results
                        break;
                    case 5: txPromise = Blockchain.contract.createDistributorBlock(...commonArgs); break;
                }

                const receipt = await Blockchain.handleTransaction(txPromise, feedbackId);
                if (receipt) {
                    this.addBatchToLocalStorage(batchId);
                    this.displayPreviousActivity();

                    // Generate QR code for Manufacturer
                    if (role === 4) {
                        const resultDiv = document.getElementById('manufacturerResult');
                        const canvas = document.getElementById('finalQrCanvas');
                        const link = document.getElementById('finalQrLink');
                        
                        const publicUrl = `https://ranveersingh18w.github.io/Sih-prototype/search.html#${encodeURIComponent(batchId)}`;
                        
                        link.href = publicUrl;
                        link.textContent = publicUrl;
                        
                        QRCode.toCanvas(canvas, publicUrl, { width: 220, margin: 2 }, function (error) {
                            if (error) console.error(error);
                            resultDiv.classList.remove('hidden');
                        });
                    }
                }
            },

            addBatchToLocalStorage(batchId) {
                let batches = JSON.parse(localStorage.getItem(`batches_${this.currentUser.wallet}`) || '[]');
                if (!batches.includes(batchId)) {
                    batches.unshift(batchId);
                }
                localStorage.setItem(`batches_${this.currentUser.wallet}`, JSON.stringify(batches.slice(0, 10)));
            },
            
            displayPreviousActivity() {
                const container = document.getElementById('previousActivity');
                let batches = JSON.parse(localStorage.getItem(`batches_${this.currentUser.wallet}`) || '[]');
                if (batches.length > 0) {
                    container.innerHTML = batches.map(id => `<p class="p-2 border-b">${id}</p>`).join('');
                } else {
                    container.innerHTML = '<p>No recent activity to show.</p>';
                }
            },

            logout() {
                sessionStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            }
        };

        // Initialize App on page load
        document.addEventListener('DOMContentLoaded', () => {
            const userData = JSON.parse(sessionStorage.getItem('currentUser'));
            if (userData) {
                App.init(userData);
            } else {
                window.location.href = 'login.html';
            }
        });
    </script>
</body>

</html>
